<%= link_to 'Back to Comparisons', research_gen_ai_comparisons_path %>
<br>

<div class="container">
  <div class="column">
    <p><%= @comparison.created_at.strftime("%B %d, %Y %H:%M") %></p>
  </div>
</div>
<hr>

<div>
  <table>
    <thead style="position: sticky; top: 0; background-color: #fff; z-index: 1;">
      <tr>
        <th class="dark-border"></th>
        <th class="dark-border">
          Feedback key
          <div style="display: flex; align-items: center;">
            <div>
              <table>
                <tr>
                  <td class='green feedback-key-font'>O</td>
                  <td>5</td>
                  <td class='feedback-key-font' style='border: none;'>
                    Optimal Match;
                    <br>
                    G-eval=5
                  </td>
                </tr>
              </table>
            </div>
            <div>
              <table>
                <tr>
                  <td class='red'>O</td>
                  <td>3</td>
                  <td class='feedback-key-font' style='border: none;'>
                    Quill sub-optimal, LLM optimal;
                    <br>
                    G-eval=3
                  </td>
                </tr>
              </table>
            </div>
            <div>
              <table>
                <tr>
                  <td class='green'>S</td>
                  <td>4</td>
                  <td class='feedback-key-font' style='border: none;'>
                    Sub-Optimal Match
                    <br>
                    G-eval=4
                  </td>
                </tr>
              </table>
            </div>
            <div>
              <table>
                <tr>
                  <td class='red'>S</td>
                  <td>2</td>
                  <td class='feedback-key-font' style='border: none;'>
                    Quill optimal, LLM sub-optimal;
                    <br>
                    G-eval=2
                  </td>
                </tr>
              </table>
            </div>
          </div>
        </th>

        <% @trials.each do |trial| %>
          <th class='dark-border-top no-border-right'></th>
          <th class='dark-border-top-bottom'></th>
          <th class="dark-border-top-bottom-right">
            <%= render 'confusion_matrix', matrix: trial.confusion_matrix %>
          </th>
        <% end %>
      </tr>
      <tr>
        <th class="dark-border">Student Response</th>
        <th class="dark-border">Quill Feedback</th>
        <% @trials.each do |trial| %>
          <td class='dark-border-top-bottom-left'></td>
          <th class='dark-border-top-bottom'></th>
          <th class="dark-border-top-bottom-right">
            <% if @comparison.llm? %>
            <%= link_to trial.llm.version, trial %>
            <% elsif @comparison.llm_prompt? %>
              <%= link_to trial.llm_prompt.description.truncate(40), trial %>
            <% end %>
          </th>
        <% end %>
      </tr>
    </thead>
    <tbody>
      <% @quill_feedbacks.each do |quill_feedback| %>
        <% student_response_id = quill_feedback.student_response_id %>
        <tr>
          <td class='dark-border'>
            <%= quill_feedback.student_response %>
          </td>
          <td class='dark-border'>
            <%= quill_feedback.text %>
          </td>
          <% @trials.each do |trial| %>
            <% llm_feedback = trial.llm_feedbacks.find_by(student_response_id: student_response_id) %>
            <% if llm_feedback %>
              <% llm_feedback_index = trial.llm_feedbacks.index(llm_feedback) %>
              <% g_eval_id = trial.g_evals&.keys&.first %>
              <% g_eval_score = trial.g_evals&.dig(g_eval_id, llm_feedback_index) || '' %>
              <td class='dark-border-top-bottom-left' style="background-color: <%= llm_feedback.optimal_or_sub_optimal_match? ? 'lightgreen' : 'lightcoral' %>;">
                <%= llm_feedback.optimal? ? :O : :S %>
              </td>
              <td class='dark-border-top-bottom'>
                <%= g_eval_score %>
              </td>
              <td class='dark-border-top-bottom-right'>
                <%= llm_feedback&.text %>
              </td>
            <% else %>
              <td class='dark-border-top-bottom-left'></td>
              <td class='dark-border-top-bottom'></td>
              <td class='dark-border-top-bottom-right'>
            <% end %>
          <% end %>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<style>
  .dark-border {
    border: 2px solid black;
  }
  .dark-border-top {
    border-top: 2px solid black;
  }
  .dark-border-left {
    border-left: 2px solid black;
  }
  .dark-border-right {
    border-right: 2px solid black;
  }
  .dark-border-top-bottom-right {
    border-top: 2px solid black;
    border-bottom: 2px solid black;
    border-right: 2px solid black;
  }
  .dark-border-top-bottom-left {
    border-top: 2px solid black;
    border-bottom: 2px solid black;
    border-left: 2px solid black;
  }
  .dark-border-top-bottom {
    border-top: 2px solid black;
    border-bottom: 2px solid black;
  }
  .feedback-key-font {
    font-size: 12px;

</style>