<% unless Rails.env.development? || Rails.env.test? || Rails.env.cypress? %>
  <!-- start Segment.io -->
  <script type="text/javascript">

    !function(){var analytics=window.analytics=window.analytics||[];if(!analytics.initialize)if(analytics.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{analytics.invoked=!0;analytics.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on"];analytics.factory=function(t){return function(){var e=Array.prototype.slice.call(arguments);e.unshift(t);analytics.push(e);return analytics}};for(var t=0;t<analytics.methods.length;t++){var e=analytics.methods[t];analytics[e]=analytics.factory(e)}analytics.load=function(t,e){var n=document.createElement("script");n.type="text/javascript";n.async=!0;n.src="https://cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(n,a);analytics._loadOptions=e};analytics.SNIPPET_VERSION="4.1.0";
    analytics.load("<%= ENV["SEGMENT_WRITE_KEY"] %>", {
        integrations: {
          all: true
          <%#= We're using @should_load_intercom as a proxy for Salesmachine
               and our new sales platform Vitally, which will replace it
               since the conditions are basically the same (teachers only).
               If we shouldn't load Intercom, then we shouldn't send any
               events to Salesmachine or Vitally, either. %>
          <% unless @should_load_intercom %>
          , Intercom: false
          , Salesmachine: false
          , Vitally: false
          <% end %>
        }
      }
    );
    <%# There are three cases here:
      #   1) we know the currently logged-in user,
      #   2) the user literally just logged out, and the controller let us know
      #   3) this is an anonymous user, in which case we don't do anything special at all
    %>
    <% if current_user %>
      analytics.identify(<%= raw(generate_segment_identify_arguments(current_user, @should_load_intercom)) %>);
    <% elsif @logging_user_out %>
      analytics.reset()
    <% end %>
    analytics.page();
    <% if @should_load_intercom %>

      setInterval(function() {
        if (typeof Intercom !== 'undefined') {
          Intercom('update');
        }
      }, 30000)
    <% else %>
      // In case a teacher was signed in on this computer and set the Intercom
      // localStorage, and then a student logged into this computer, let's
      // explicitly tell Intercom to shut it down so the student does not
      // see Intercom.
      window.onload = function() {
        if (typeof Intercom !== 'undefined') {
          Intercom('shutdown');
        }
      };
    <% end %>
  }}();
  </script>
  <!-- end Segment.io -->
<% end %>
